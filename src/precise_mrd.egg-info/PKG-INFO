Metadata-Version: 2.4
Name: precise-mrd
Version: 0.1.0
Summary: ctDNA/UMI MRD simulator + caller with deterministic error modeling and LoB/LoD estimation
Author-email: Precise MRD Team <team@precise-mrd.org>
License: MIT
Project-URL: Homepage, https://github.com/precise-mrd/precise-mrd-mini
Project-URL: Documentation, https://precise-mrd.github.io/precise-mrd-mini/
Project-URL: Repository, https://github.com/precise-mrd/precise-mrd-mini
Project-URL: Issues, https://github.com/precise-mrd/precise-mrd-mini/issues
Project-URL: Changelog, https://github.com/precise-mrd/precise-mrd-mini/blob/main/CHANGELOG.md
Keywords: ctdna,mrd,minimal-residual-disease,umi,bioinformatics,cancer-genomics
Classifier: Development Status :: 4 - Beta
Classifier: Intended Audience :: Science/Research
Classifier: License :: OSI Approved :: MIT License
Classifier: Operating System :: OS Independent
Classifier: Programming Language :: Python :: 3
Classifier: Programming Language :: Python :: 3.10
Classifier: Programming Language :: Python :: 3.11
Classifier: Programming Language :: Python :: 3.12
Classifier: Topic :: Scientific/Engineering :: Bio-Informatics
Classifier: Topic :: Scientific/Engineering :: Medical Science Apps.
Classifier: Typing :: Typed
Requires-Python: >=3.10
Description-Content-Type: text/markdown
License-File: LICENSE
Requires-Dist: numpy>=1.24.0
Requires-Dist: pandas>=2.0.0
Requires-Dist: scipy>=1.10.0
Requires-Dist: statsmodels>=0.14.0
Requires-Dist: matplotlib>=3.7.0
Requires-Dist: seaborn>=0.12.0
Requires-Dist: pyyaml>=6.0
Requires-Dist: jinja2>=3.1.0
Requires-Dist: typer>=0.9.0
Requires-Dist: tqdm>=4.65.0
Requires-Dist: scikit-learn>=1.3.0
Provides-Extra: dev
Requires-Dist: pytest>=7.4.0; extra == "dev"
Requires-Dist: pytest-cov>=4.1.0; extra == "dev"
Requires-Dist: pytest-mock>=3.11.0; extra == "dev"
Requires-Dist: hypothesis>=6.80.0; extra == "dev"
Requires-Dist: ruff>=0.0.280; extra == "dev"
Requires-Dist: black>=23.0.0; extra == "dev"
Requires-Dist: mypy>=1.5.0; extra == "dev"
Requires-Dist: pre-commit>=3.3.0; extra == "dev"
Requires-Dist: coverage-badge>=1.1.0; extra == "dev"
Requires-Dist: bandit>=1.7.5; extra == "dev"
Requires-Dist: pip-tools>=7.0.0; extra == "dev"
Provides-Extra: docs
Requires-Dist: mkdocs>=1.5.0; extra == "docs"
Requires-Dist: mkdocs-material>=9.2.0; extra == "docs"
Requires-Dist: mkdocstrings[python]>=0.23.0; extra == "docs"
Requires-Dist: mkdocs-gen-files>=0.5.0; extra == "docs"
Requires-Dist: mkdocs-literate-nav>=0.6.0; extra == "docs"
Requires-Dist: mkdocs-section-index>=0.3.6; extra == "docs"
Provides-Extra: rust
Requires-Dist: maturin>=1.0.0; extra == "rust"
Dynamic: license-file

# Precise MRD

[![CI](https://github.com/user/precise-mrd-mini/workflows/CI/badge.svg)](https://github.com/user/precise-mrd-mini/actions)
[![Coverage](https://img.shields.io/badge/coverage-85%25-brightgreen.svg)](coverage.svg)
[![Python 3.11](https://img.shields.io/badge/python-3.11-blue.svg)](https://www.python.org/downloads/)
[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](LICENSE)

A ctDNA/UMI toy MRD pipeline with UMI-aware error modeling, LoB/LoD estimation, contamination controls, and comprehensive reporting.

## Features

ğŸ§¬ **UMI-Aware Error Modeling**
- Consensus UMI calling with family-size thresholds
- Trinucleotide context-specific error rates
- Quality-weighted consensus with configurable parameters

ğŸ“Š **Statistical Analysis**
- Poisson/binomial hypothesis testing
- Benjamini-Hochberg FDR correction
- P-value calibration and validation

ğŸ¯ **LoB/LoD Estimation**
- Bootstrap-based LoD95 estimation
- Detection probability curves across AFÃ—depth grids
- Limit of Blank calculation from negative controls

ğŸ”¬ **Quality Control**
- Strand bias detection with Fisher's exact test
- End-repair artifact filtering
- Clinical guardrail validation

ğŸ“ˆ **Contamination Modeling**
- Cross-sample contamination simulation
- Barcode swap rate estimation
- Contamination impact assessment

ğŸ“‹ **Comprehensive Reporting**
- Interactive HTML reports with embedded plots
- LoD heatmaps and detection curves
- QC metrics and performance summaries

## Quickstart

**3-command demo** (deterministic, CPU-only, <5 minutes):

```bash
make setup     # Install dependencies and package in editable mode
make smoke     # Run fast end-to-end pipeline with synthetic data
```

The smoke test runs a complete MRD pipeline with minimal synthetic data, producing `reports/metrics.json` and `reports/auto_report.html` with ROC/PR curves and detection metrics.

### Docker

```bash
docker build -t precise-mrd-mini:cpu -f Dockerfile.cpu .
docker run --rm -v $PWD/reports:/app/reports precise-mrd-mini:cpu
```

## Determinism & Reproducibility

All pipeline stages use **fixed seeds** to ensure reproducible results:
- Smoke test uses `seed=7` by default
- Golden hash testing validates first 10 variant scores remain stable
- Artifacts include `run_context.json` with seed, timestamp, and full configuration
- Test suite includes determinism checks with SHA256 validation

## Artifact Contract

The smoke path produces:
- `reports/metrics.json` - ROC AUC, PR AUC, detection stats with 95% CI
- `reports/auto_report.html` - Interactive HTML report with plots
- `reports/run_context.json` - Complete reproducibility metadata

## Full Pipeline (Snakemake)

```bash
# Run simulation with default parameters
make simulate

# Generate HTML report
make report

# Run quick simulation for CI/testing
make ci-small

# Performance benchmark
make benchmark
```

### Command Line Interface

```bash
# Initialize custom configuration
precise-mrd init-config --output configs/my_analysis.yaml

# Run simulation
precise-mrd simulate --config configs/my_analysis.yaml --run-id my_analysis

# Generate report
precise-mrd report --results results/latest

# Validate results
precise-mrd validate --results results/latest

# Performance benchmark
precise-mrd benchmark
```

## Configuration

### Default Configuration (`configs/default.yaml`)

```yaml
run_id: "default_run"
seed: 42

simulation:
  allele_fractions: [0.05, 0.01, 0.001, 0.0005, 0.0001]
  umi_depths: [5000, 10000, 20000, 50000]
  n_replicates: 1000
  n_bootstrap: 1000

umi:
  min_family_size: 3
  max_family_size: 1000
  quality_threshold: 20
  consensus_threshold: 0.6

stats:
  test_type: "poisson"  # or "binomial"
  alpha: 0.05
  fdr_method: "benjamini_hochberg"

lod:
  detection_threshold: 0.95
  confidence_level: 0.95
```

### Key Parameters

- **allele_fractions**: Range of allele fractions to test (0.01% to 5%)
- **umi_depths**: UMI family depths for simulation grid
- **min_family_size**: Minimum UMI family size for consensus calling
- **test_type**: Statistical test (`poisson` or `binomial`)
- **detection_threshold**: LoD95 detection probability threshold

## Pipeline Overview

### 1. UMI Consensus Calling

```python
from precise_mrd import UMIProcessor

processor = UMIProcessor(min_family_size=3, consensus_threshold=0.6)
families = processor.process_reads(reads)
consensus_data = processor.get_consensus_counts(families)
```

- Groups reads by UMI and genomic position
- Calls consensus with quality weighting
- Filters families by size thresholds
- Handles outlier family sizes

### 2. Error Modeling

```python
from precise_mrd import ErrorModel, ContextAnalyzer

error_model = ErrorModel()
context_analyzer = ContextAnalyzer()

# Estimate context-specific error rates
error_rates = error_model.estimate_background_errors(negative_control_data)
```

- Trinucleotide context normalization
- Background error estimation from negative controls
- Contamination rate modeling

### 3. Statistical Testing

```python
from precise_mrd import StatisticalTester

tester = StatisticalTester(test_type="poisson", alpha=0.05)
results = tester.test_multiple_variants(variant_data, error_rates)
```

- Per-locus hypothesis testing
- Multiple testing correction (FDR)
- Effect size calculation

### 4. LoD/LoB Estimation

```python
from precise_mrd import LODEstimator

estimator = LODEstimator(detection_threshold=0.95)
lod_result = estimator.bootstrap_lod_estimation(simulation_results, depth=10000)
```

- Bootstrap confidence intervals
- Detection probability curves
- Clinical sensitivity metrics

## Assumptions and Limitations

### Biological Assumptions

1. **UMI Families**: Reads sharing UMIs originate from the same DNA molecule
2. **Error Independence**: Sequencing errors are independent across reads
3. **Context Effects**: Error rates vary by trinucleotide context
4. **Contamination Model**: Cross-sample contamination follows barcode swap patterns

### Technical Limitations

1. **Synthetic Data**: Uses simulated reads, not real FASTQ files
2. **Simplified Contamination**: Basic contamination model
3. **Context Dependencies**: Limited trinucleotide contexts implemented
4. **Performance**: Python implementation (Rust extension optional)

### Statistical Considerations

1. **Multiple Testing**: FDR correction assumes independence
2. **Bootstrap Validity**: Requires sufficient replicates for stable estimates
3. **P-value Calibration**: Depends on accurate error model
4. **LoD Definition**: Based on 95% detection probability threshold

## Performance

### Benchmarks (N=1e6 reads)

| Operation | Pure Python | Rust Extension | Speedup |
|-----------|-------------|----------------|---------|
| UMI Grouping | 2.3s | 1.1s | 2.1Ã— |
| Consensus Calling | 1.8s | 0.9s | 2.0Ã— |
| Statistical Testing | 0.5s | 0.5s | 1.0Ã— |

*Benchmarks on MacBook Pro M1, 16GB RAM*

### Memory Usage

- **Small simulation** (CI): ~200MB peak
- **Default simulation**: ~1.2GB peak  
- **Large simulation** (1M families): ~4.8GB peak

## Clinical Guardrails

### Sample Validity Criteria

```python
# Minimum requirements for valid sample
qc_thresholds = {
    'min_total_umi_families': 1000,
    'max_contamination_rate': 0.05,
    'min_depth_per_locus': 100,
    'min_consensus_rate': 0.8
}
```

### Invalid Sample Criteria

- **Insufficient depth**: <1000 total UMI families
- **High contamination**: >5% estimated contamination rate
- **Poor consensus**: <80% consensus calling rate
- **Technical failure**: Multiple QC metrics outside acceptable ranges

## Results Interpretation

### LoD95 Values

- **Excellent** (â‰¤0.01%): Suitable for MRD monitoring
- **Good** (0.01-0.1%): Adequate for most clinical applications  
- **Acceptable** (0.1-1%): Limited sensitivity, use with caution
- **Poor** (>1%): Insufficient for MRD detection

### LoB Interpretation

- **LoB <1%**: Low false positive rate, high specificity
- **LoB 1-5%**: Moderate false positive rate, acceptable for screening
- **LoB >5%**: High false positive rate, requires optimization

### QC Metrics

- **Strand bias p-value <0.01**: Potential technical artifact
- **End-repair enrichment**: Filter G>T/C>A near fragment ends
- **Family size distribution**: Log-normal expected, extreme outliers flagged

## Output Files

### Results Directory Structure

```
results/runs/<run_id>/
â”œâ”€â”€ detection_matrix.csv      # AFÃ—depth detection probabilities
â”œâ”€â”€ statistical_results.csv   # Per-variant test results
â”œâ”€â”€ filter_results.csv        # Quality filter outcomes
â”œâ”€â”€ qc_metrics.json          # Quality control metrics
â”œâ”€â”€ runtime_metrics.json     # Performance measurements
â””â”€â”€ lockfile.json           # Reproducibility metadata
```

### HTML Report Sections

1. **Summary**: Key metrics and performance indicators
2. **LoD Analysis**: Detection curves and LoD95 estimates  
3. **LoB Analysis**: False positive rates and thresholds
4. **Context Analysis**: Error rates by trinucleotide context
5. **QC Metrics**: Sample quality and filter performance
6. **Configuration**: Run parameters and reproducibility info

## Development

### Running Tests

```bash
# Unit tests with coverage
make coverage

# Specific test modules
pytest tests/test_umi.py -v
pytest tests/test_stats.py -v
pytest tests/test_lod.py -v

# Performance tests
python -m precise_mrd.profiling
```

### Code Quality

```bash
# Linting and formatting
make lint
make format

# Type checking
mypy src/precise_mrd/

# Security scan
bandit -r src/
```

### Building Documentation

```bash
# Generate API documentation
sphinx-build -b html docs/ docs/_build/

# Update validation report
make report
# -> Updates docs/validation.md automatically
```

## Contributing

1. Fork the repository
2. Create a feature branch (`git checkout -b feature/amazing-feature`)
3. Commit your changes (`git commit -m 'Add amazing feature'`)
4. Push to the branch (`git push origin feature/amazing-feature`)
5. Open a Pull Request

### Development Setup

```bash
# Install development dependencies
pip install -r requirements.txt
pip install -e .[dev]

# Setup pre-commit hooks
pre-commit install

# Run full test suite
make test
```

## Citation

If you use this pipeline in your research, please cite:

```bibtex
@software{precise_mrd,
  title = {Precise MRD: ctDNA/UMI MRD Pipeline},
  author = {Precise MRD Team},
  url = {https://github.com/user/precise-mrd-mini},
  version = {0.1.0},
  year = {2024}
}
```

## License

This project is licensed under the MIT License - see the [LICENSE](LICENSE) file for details.

## Support

- ğŸ“– [Documentation](https://user.github.io/precise-mrd-mini/)
- ğŸ› [Issue Tracker](https://github.com/user/precise-mrd-mini/issues)
- ğŸ’¬ [Discussions](https://github.com/user/precise-mrd-mini/discussions)

## Acknowledgments

- Inspired by best practices in clinical NGS pipelines
- Statistical methods adapted from cancer genomics literature
- UMI consensus algorithms based on published protocols
